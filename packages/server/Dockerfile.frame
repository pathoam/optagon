# Optagon Frame Container
# Base image for development frames with tmux, Node.js, Python, and Playwright

FROM ubuntu:24.04

# Avoid prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    # Terminal and shell
    tmux \
    zsh \
    # Build essentials
    build-essential \
    git \
    curl \
    wget \
    unzip \
    # Python
    python3 \
    python3-pip \
    python3-venv \
    # Node.js prerequisites
    ca-certificates \
    gnupg \
    # Playwright dependencies
    libnss3 \
    libnspr4 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libdbus-1-3 \
    libxkbcommon0 \
    libatspi2.0-0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libasound2t64 \
    libpango-1.0-0 \
    libcairo2 \
    # Useful tools
    jq \
    ripgrep \
    fd-find \
    htop \
    ncdu \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 22 LTS
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install Bun
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:${PATH}"

# Install pnpm
RUN npm install -g pnpm

# Install podman-docker (provides docker CLI via podman) and docker-compose
RUN apt-get update && \
    apt-get install -y podman-docker && \
    rm -rf /var/lib/apt/lists/* && \
    # Install docker-compose standalone
    curl -fsSL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-$(uname -m)" -o /usr/local/bin/docker-compose && \
    chmod +x /usr/local/bin/docker-compose

# Install Tilt (local Kubernetes/Docker dev tool)
RUN TILT_VERSION=$(curl -fsSL https://api.github.com/repos/tilt-dev/tilt/releases/latest | jq -r .tag_name) && \
    curl -fsSL "https://github.com/tilt-dev/tilt/releases/download/${TILT_VERSION}/tilt.${TILT_VERSION#v}.linux.x86_64.tar.gz" | tar -xz -C /usr/local/bin tilt

# Install Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

# Install OpenCode (OpenRouter-compatible code agent)
RUN curl -fsSL https://opencode.ai/install | bash
ENV PATH="/root/.opencode/bin:${PATH}"

# Create directories
RUN mkdir -p /workspace /run/optagon

# Copy browser-tool CLI
COPY frame-image/browser-tool /opt/browser-tool

# Copy optagon documentation and tools reference
COPY frame-image/optagon-home /opt/optagon

# Add discoverable pointer in home directory
COPY frame-image/home-readme.md /root/README.md

# Create helper command
RUN echo '#!/bin/bash' > /usr/local/bin/frame-context && \
    echo 'cat /opt/optagon/README.md' >> /usr/local/bin/frame-context && \
    chmod +x /usr/local/bin/frame-context

# Install browser-tool dependencies and Playwright browsers
WORKDIR /opt/browser-tool
RUN bun install && bunx playwright install chromium && bunx playwright install-deps chromium

# Create global browser-tool CLI wrapper
RUN echo '#!/bin/bash' > /usr/local/bin/browser-tool && \
    echo 'cd /opt/browser-tool && bun run browser-tool.ts "$@"' >> /usr/local/bin/browser-tool && \
    chmod +x /usr/local/bin/browser-tool

# Set up tmux configuration
RUN echo 'set -g mouse on' > /root/.tmux.conf && \
    echo 'set -g history-limit 50000' >> /root/.tmux.conf && \
    echo 'set -g default-terminal "screen-256color"' >> /root/.tmux.conf && \
    echo 'set -sg escape-time 0' >> /root/.tmux.conf && \
    echo 'set -g status-bg colour235' >> /root/.tmux.conf && \
    echo 'set -g status-fg white' >> /root/.tmux.conf && \
    echo 'set -g status-left "#[fg=green]#S "' >> /root/.tmux.conf && \
    echo 'set -g status-right "#[fg=yellow]#H"' >> /root/.tmux.conf && \
    # Allow terminal native copy with mouse (hold Shift, or use these bindings)
    echo 'set -g set-clipboard on' >> /root/.tmux.conf && \
    echo 'bind-key -T copy-mode MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel' >> /root/.tmux.conf

# Set up zsh as default shell
RUN chsh -s /bin/zsh root

# Copy and setup the startup script
COPY frame-image/start-frame.sh /usr/local/bin/start-frame.sh
RUN chmod +x /usr/local/bin/start-frame.sh

# Suppress ALL zsh startup noise
# Create empty global configs to prevent Ubuntu defaults
RUN rm -f /etc/zsh/zshrc /etc/zsh/zprofile /etc/zsh/zlogin /etc/zsh/zlogout 2>/dev/null || true && \
    touch /etc/zsh/zshrc /etc/zsh/zprofile && \
    # Create minimal user config
    echo '# Optagon frame - docs at /opt/optagon/' > /root/.zshrc && \
    echo 'export PS1="%~ $ "' >> /root/.zshrc && \
    # Prevent zsh new user setup wizard
    touch /root/.zshenv && \
    echo 'skip_global_compinit=1' > /root/.zshenv

# Set working directory
WORKDIR /workspace

# Environment variables
ENV TERM=xterm-256color
ENV SHELL=/bin/zsh

# Default ports
EXPOSE 3000
EXPOSE 10350

# Start tmux server
CMD ["/usr/local/bin/start-frame.sh"]
